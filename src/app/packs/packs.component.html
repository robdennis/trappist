@if (pack(); as pack) {
    <div class="pack-grid-layout">
      <!-- Left Column: Pack Info -->
      <div class="pack-info-left">
         <mat-form-field class="pack-name-input">
          <mat-label>Pack Name</mat-label>
          <input matInput [ngModel]="pack.name" (ngModelChange)="onPackMetaChange('name', $event)">
        </mat-form-field>

        <div class="signpost-image-container">
            @if (getSignpostCardArtCrop(pack); as artCropUrl) {
                <img [src]="artCropUrl" alt="Signpost card art">
            } @else {
                <div class="no-image-placeholder">
                <mat-icon>photo_library</mat-icon>
                <span>No Signpost Image</span>
                </div>
            }
        </div>

        <div class="pack-details-bottom">
            <mat-form-field>
              <mat-label>Archetype</mat-label>
              <input matInput [ngModel]="getCurrentRevision(pack).archetype" (ngModelChange)="onPackMetaChange('archetype', $event)">
            </mat-form-field>
            <mat-form-field>
              <mat-label>Themes</mat-label>
              <input matInput [ngModel]="getCurrentRevision(pack).themes" (ngModelChange)="onPackMetaChange('themes', $event)">
            </mat-form-field>
        </div>
      </div>

      <!-- Right Column: Card Slots -->
      <div class="card-slots-right">
          <div class="pack-header">
              <h3>
                  {{ pack.name }}
                  <span class="pack-count">({{ getFilledSlotsCount(pack) }} / {{ getCurrentRevision(pack).size }})</span>
                  @if(isDirty()) {
                    <mat-icon class="provisional-indicator" matTooltip="Unsaved changes">edit</mat-icon>
                  }
              </h3>
              <div class="pack-actions">
                @if(isDirty()) {
                    <div class="provisional-actions">
                        <button mat-flat-button color="primary" (click)="savePack.emit(pack)">
                            <mat-icon>save</mat-icon> Save
                        </button>
                        <button mat-stroked-button (click)="discardChanges.emit(pack.id)">
                            <mat-icon>undo</mat-icon> Discard
                        </button>
                    </div>
                }
                <button mat-stroked-button color="warn" (click)="removePack.emit(pack.id)">
                    <mat-icon>delete</mat-icon> Delete Pack
                </button>
              </div>
          </div>

          <div class="card-slots-grid-container">
              <div class="slot-labels-column">
                  @for (slotIndex of getSlotsArray(pack); track slotIndex) {
                      <div class="slot-label">
                          <input class="slot-input"
                                 [ngModel]="getCurrentRevision(pack).slots?.[slotIndex]"
                                 (ngModelChange)="onSlotLabelChange(slotIndex, $event)">
                      </div>
                  }
              </div>
              <div class="card-drop-list" cdkDropList [cdkDropListData]="pack.cards" (cdkDropListDropped)="onCardDrop($event)">
                  @for (slotIndex of getSlotsArray(pack); track slotIndex) {
                      <div class="card-row" cdkDrag [cdkDragData]="pack.cards[slotIndex]" [cdkDragDisabled]="!pack.cards[slotIndex]">
                          <div class="slot-drag-handle" cdkDragHandle>
                              @if (pack.cards[slotIndex]) { <mat-icon>drag_indicator</mat-icon> }
                          </div>
                          @if(pack.cards[slotIndex]; as card) {
                              <div class="tags-cell">
                                @for(tagId of card.tags; track tagId) {
                                    @if(tagIdMap().get(tagId); as tag) {
                                    <span class="card-tag" [matTooltip]="getTagTooltip(tagId)">
                                        @switch (getIconType(tag.icon)) {
                                            @case ('fa') { <i [class]="tag.icon"></i> }
                                            @case ('ms') { <i class="ms {{tag.icon}}"></i> }
                                            @case ('svg') { <img [src]="tag.icon" class="svg-icon" alt="Set Icon"> }
                                            @case ('emoji') { <span>{{ tag.icon }}</span> }
                                        }
                                    </span>
                                    }
                                }
                              </div>
                              <div class="mana-cost-cell" (mouseenter)="showCardImage(card)" (mouseleave)="hideCardImage()">
                                  <span [innerHTML]="getDisplayManaCost(card) | manaSymbol"></span>
                              </div>
                              <div class="card-cell" (mouseenter)="showCardImage(card)" (mouseleave)="hideCardImage()"
                                [class.is-signpost-card]="card.id === getCurrentRevision(pack).signpostCardId">
                                  <span class="card-name">{{ card.name }}</span>
                              </div>
                              <div class="actions-cell">
                                  <button mat-icon-button matTooltip="Set as signpost card" (click)="setSignpostCard(card.id)">
                                      <mat-icon>push_pin</mat-icon>
                                  </button>
                                  <button mat-icon-button color="warn" matTooltip="Remove card" (click)="removeCardFromSlot(slotIndex)">
                                      <mat-icon>remove_circle_outline</mat-icon>
                                  </button>
                              </div>
                          } @else {
                              <div class="tags-cell empty"></div>
                              <div class="mana-cost-cell empty"></div>
                              <div class="card-cell empty">
                                  <mat-form-field class="slot-search-field">
                                      <input type="text" matInput
                                          [formControl]="slotControls[slotIndex]"
                                          [matAutocomplete]="auto"
                                          (focus)="setActiveSlot(slotIndex)">
                                      <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn" (optionSelected)="addCardToSlot($event.option.value, slotIndex)">
                                      @for (suggestion of suggestions(); track suggestion.id) {
                                          <mat-option [value]="suggestion" (mouseenter)="showCardImage(suggestion)" (mouseleave)="hideCardImage()">
                                            <div class="suggestion-item">
                                                <span class="suggestion-name">{{ suggestion.name }}</span>
                                                <span class="suggestion-meta" [class.has-mana-cost]="getDisplayManaCost(suggestion)" [class.no-mana-cost]="!getDisplayManaCost(suggestion)">
                                                    @if (getDisplayManaCost(suggestion); as manaCost) {
                                                    <span class="mana-cost" [innerHTML]="manaCost | manaSymbol"></span>
                                                    } @else {
                                                    <span class="suggestion-color-identity" [innerHTML]="getColorIdentityManaString(suggestion) | manaSymbol"></span>
                                                    <span class="suggestion-type-line">{{ suggestion.type_line }}</span>
                                                    }
                                                </span>
                                            </div>
                                          </mat-option>
                                      }
                                      </mat-autocomplete>
                                  </mat-form-field>
                              </div>
                              <div class="actions-cell empty"></div>
                          }
                      </div>
                  }
              </div>
          </div>

        <mat-expansion-panel class="history-panel">
            <mat-expansion-panel-header>
                <mat-panel-title><mat-icon>history</mat-icon>Revision History ({{pack.revisions.length}})</mat-panel-title>
            </mat-expansion-panel-header>
            <mat-list>
                @for(revision of pack.revisions.slice().reverse(); track revision.timestamp){
                    <mat-list-item [class.current-revision]="revision.timestamp === getCurrentRevision(pack).timestamp">
                        <div class="revision-item">
                            <span>{{formatTimestamp(revision.timestamp)}} - {{ revision.reason || (revision.cardIds.length + ' cards') }}</span>
                            <button mat-stroked-button (click)="revertToRevision(revision)" [disabled]="revision.timestamp === getCurrentRevision(pack).timestamp">
                                Revert
                            </button>
                        </div>
                    </mat-list-item>
                }
            </mat-list>
        </mat-expansion-panel>
      </div>
    </div>
}

@if (hoveredCard(); as card) {
  <div class="card-image-preview" [style.left.px]="mousePos().x + 20" [style.top.px]="mousePos().y + 20" [class.rotated]="card.layout === 'split'">
    @if (card.image_uris?.normal) {
      <img [src]="card.image_uris?.normal" [alt]="card.name">
    } @else if (card.card_faces) {
      @for (face of card.card_faces; track $index) {
        @if(face.image_uris?.normal){
          <img [src]="face.image_uris?.normal" [alt]="face.name">
        }
      }
    }
  </div>
}

