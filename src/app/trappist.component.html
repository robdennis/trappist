<mat-toolbar color="primary" class="main-toolbar">
  <span>Trappist Deck Builder</span>
</mat-toolbar>

<div class="page-container">
  @if (!dataExists()) {
    <mat-card class="content-card">
      <mat-card-header>
        <mat-card-title>Load Card Data</mat-card-title>
        <mat-card-subtitle>{{ status() }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        @if (isChecking() || isLoadingOptions()) {
          <div class="spinner-container">
            <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
          </div>
        } @else {
          <!-- Local File Upload -->
          <h3 class="data-source-header">Option 1: Upload from a local file</h3>
          <p class="data-source-description">
            If you have already downloaded a Scryfall bulk data JSON file, you can upload it here.
          </p>
          <div class="input-row">
              <button mat-stroked-button color="primary" (click)="fileInput.click()">
                <mat-icon>upload_file</mat-icon>
                Choose File
              </button>
              <input hidden (change)="onFileSelected($event)" #fileInput type="file" accept=".json">
              @if (selectedFile(); as file) {
                <span class="file-name">{{ file.name }}</span>
              }
              <button mat-raised-button color="primary" (click)="uploadAndStoreData()" [disabled]="!selectedFile() || isLoading()">
                  {{ isLoading() ? 'Uploading...' : 'Upload Data' }}
              </button>
          </div>

          <mat-divider class="section-divider"></mat-divider>

          <!-- Scryfall Bulk Data Options -->
          <h3 class="data-source-header">Option 2: Load directly from Scryfall</h3>
          <p class="data-source-description">
            Select a dataset to download from Scryfall and load it directly into the application's local database.
          </p>
          <mat-list>
            @for (option of bulkDataOptions(); track option.id) {
              <mat-list-item class="bulk-data-item">
                <mat-icon matListItemIcon>description</mat-icon>
                <div matListItemTitle class="item-title">{{ option.name }}</div>
                <div matListItemLine class="item-description">{{ option.description }}</div>
                <div matListItemLine class="item-meta">
                  <span><strong>Size:</strong> {{ formatBytes(option.size) }}</span>
                  <span><strong>Last Updated:</strong> {{ formatLastUpdated(option.updated_at) }}</span>
                </div>
                <div matListItemMeta class="item-actions">
                    <button mat-stroked-button (click)="downloadFileLocally(option)" matTooltip="Download this file to your computer for later use.">
                      <mat-icon>download</mat-icon> Download to Computer
                    </button>
                    <button mat-raised-button color="primary" (click)="downloadAndStoreData(option)" [disabled]="isLoading()">
                      {{ isLoading() ? 'Loading...' : 'Load into App' }}
                    </button>
                </div>
              </mat-list-item>
            }
          </mat-list>
        }
        @if (isLoading()) {
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        }
        @if (fileErrorDetails(); as error) {
            <div class="error-details">{{ error }}</div>
        }
      </mat-card-content>
    </mat-card>
  } @else {
    <div class="builder-section">
      <mat-card class="content-card control-panel">
        <mat-card-content class="button-row">
          <mat-form-field class="active-pack-selector">
            <mat-label>Active Pack</mat-label>
            <mat-select [value]="activePackId()" (valueChange)="setActivePack($event)">
              @for (pack of packs(); track pack.id) {
                <mat-option [value]="pack.id">{{ pack.name }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
          <button mat-stroked-button color="primary" (click)="addPack()">
            <mat-icon>add_circle_outline</mat-icon> Add New Pack
          </button>
          <button mat-stroked-button (click)="exportPacks()">
            <mat-icon>download</mat-icon> Export Packs
          </button>
          <button mat-stroked-button (click)="triggerPacksImport()">
            <mat-icon>upload</mat-icon> Import Packs
          </button>
          <input type="file" class="hidden-file-input" #packsImporter accept=".json" (change)="importPacks($event)">
           @if (activePack(); as pack) {
             <button mat-stroked-button color="warn" (click)="removePack(pack.id)">
                <mat-icon>delete</mat-icon> Delete Active Pack
              </button>
           }
          <button mat-stroked-button color="warn" [matMenuTriggerFor]="clearMenu">
            <mat-icon>delete_forever</mat-icon> Clear All Data
          </button>
          <mat-menu #clearMenu="matMenu">
            <button mat-menu-item (click)="clearCardData()">
              <mat-icon>style</mat-icon>
              <span>Clear Card Data</span>
            </button>
            <button mat-menu-item (click)="clearPackData()">
              <mat-icon>inventory_2</mat-icon>
              <span>Clear Pack Data</span>
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="clearAllData()">
              <mat-icon color="warn">warning</mat-icon>
              <span>Clear All Data</span>
            </button>
          </mat-menu>
        </mat-card-content>
      </mat-card>

      <div class="packs-container">
        @if (activePack(); as pack) {
          <div class="pack-grid-layout">
            <!-- Left Column: Pack Info -->
            <div class="pack-info-left">
               <mat-form-field class="pack-name-input">
                <mat-label>Pack Name</mat-label>
                <input matInput [ngModel]="pack.name" (ngModelChange)="onPackMetaChange(pack.id, 'name', $event)">
              </mat-form-field>

              <div class="signpost-image-container">
                @if (getSignpostCardArtCrop(pack); as artCropUrl) {
                  <img [src]="artCropUrl" alt="Signpost card art">
                } @else {
                  <div class="no-image-placeholder">
                    <mat-icon>photo_library</mat-icon>
                    <span>No Signpost Image</span>
                  </div>
                }
              </div>

              <div class="pack-details-bottom">
                  <mat-form-field>
                    <mat-label>Archetype</mat-label>
                    <input matInput [ngModel]="getCurrentRevision(pack).archetype" (ngModelChange)="onPackMetaChange(pack.id, 'archetype', $event)">
                  </mat-form-field>
                  <mat-form-field>
                    <mat-label>Themes</mat-label>
                    <input matInput [ngModel]="getCurrentRevision(pack).themes" (ngModelChange)="onPackMetaChange(pack.id, 'themes', $event)">
                  </mat-form-field>
              </div>
            </div>

            <!-- Right Column: Card Slots -->
            <div class="card-slots-right">
                <div class="pack-header">
                    <h3>
                        {{ pack.name }}
                        <span class="pack-count">({{ getFilledSlotsCount(pack) }} / {{ getCurrentRevision(pack).size }})</span>
                        <mat-icon *ngIf="provisionalChanges().has(pack.id)" class="provisional-indicator" matTooltip="Unsaved changes">edit</mat-icon>
                    </h3>
                    @if(provisionalChanges().has(pack.id)) {
                        <div class="provisional-actions">
                            <button mat-flat-button color="primary" (click)="savePackChanges(pack.id)">
                                <mat-icon>save</mat-icon> Save
                            </button>
                            <button mat-stroked-button (click)="discardPackChanges(pack.id)">
                                <mat-icon>undo</mat-icon> Discard
                            </button>
                        </div>
                    }
                </div>

                <div class="card-slots-grid-container">
                    <div class="slot-labels-column">
                        @for (slotIndex of getSlotsArray(pack); track slotIndex) {
                            <div class="slot-label">
                                <input class="slot-input"
                                       [ngModel]="getCurrentRevision(pack).slots?.[slotIndex]"
                                       (ngModelChange)="onSlotLabelChange(pack.id, slotIndex, $event)">
                            </div>
                        }
                    </div>
                    <div class="card-drop-list" cdkDropList [cdkDropListData]="pack.cards" (cdkDropListDropped)="onCardDrop($event)">
                        @for (slotIndex of getSlotsArray(pack); track slotIndex) {
                            <div class="card-row" cdkDrag [cdkDragData]="pack.cards[slotIndex]" [cdkDragDisabled]="!pack.cards[slotIndex]">
                                <div class="slot-drag-handle" cdkDragHandle>
                                    @if (pack.cards[slotIndex]) {
                                        <mat-icon>drag_indicator</mat-icon>
                                    }
                                </div>
                                @if(pack.cards[slotIndex]; as card) {
                                    <!-- Filled Slot -->
                                    <div class="mana-cost-cell" (mouseenter)="showCardImage(card)" (mouseleave)="hideCardImage()">
                                        <span [innerHTML]="getDisplayManaCost(card) | manaSymbol"></span>
                                    </div>
                                    <div class="card-cell"
                                        (mouseenter)="showCardImage(card)"
                                        (mouseleave)="hideCardImage()"
                                        [class.is-signpost-card]="card.id === getCurrentRevision(pack).signpostCardId">
                                        <span class="card-name">{{ card.name }}</span>
                                    </div>
                                    <div class="actions-cell">
                                        <button mat-icon-button matTooltip="Set as signpost card" (click)="setSignpostCard(pack.id, card.id)">
                                            <mat-icon>push_pin</mat-icon>
                                        </button>
                                        <button mat-icon-button color="warn" matTooltip="Remove card" (click)="removeCardFromSlot(pack.id, slotIndex)">
                                            <mat-icon>remove_circle_outline</mat-icon>
                                        </button>
                                    </div>
                                } @else {
                                    <!-- Empty Slot -->
                                    <div class="mana-cost-cell empty"></div>
                                    <div class="card-cell empty">
                                        <mat-form-field class="slot-search-field">
                                            <input type="text"
                                                matInput
                                                [formControl]="slotControls[slotIndex]"
                                                [matAutocomplete]="auto"
                                                (focus)="setActiveSlot(slotIndex)">
                                            <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn" (optionSelected)="addCardToSlot($event.option.value, slotIndex)">
                                            @for (suggestion of suggestions(); track suggestion.id) {
                                                <mat-option [value]="suggestion">
                                                <div class="suggestion-item">
                                                    <span>{{ suggestion.name }}</span>
                                                    <span class="mana-cost" [innerHTML]="getDisplayManaCost(suggestion) | manaSymbol"></span>
                                                </div>
                                                </mat-option>
                                            }
                                            </mat-autocomplete>
                                        </mat-form-field>
                                    </div>
                                    <div class="actions-cell empty"></div>
                                }
                            </div>
                        }
                    </div>
                </div>

                <mat-expansion-panel class="history-panel">
                  <mat-expansion-panel-header>
                      <mat-panel-title>
                          <mat-icon>history</mat-icon>
                          Revision History ({{pack.revisions.length}})
                      </mat-panel-title>
                  </mat-expansion-panel-header>
                  <mat-list>
                      @for(revision of pack.revisions.slice().reverse(); track revision.timestamp){
                          <mat-list-item [class.current-revision]="revision.timestamp === getCurrentRevision(pack).timestamp">
                              <div class="revision-item">
                                  <span>{{formatTimestamp(revision.timestamp)}} - {{ revision.reason || (revision.cardIds.length + ' cards') }}</span>
                                  <button mat-stroked-button (click)="revertToRevision(pack.id, revision)" [disabled]="revision.timestamp === getCurrentRevision(pack).timestamp">
                                      Revert
                                  </button>
                              </div>
                          </mat-list-item>
                      }
                  </mat-list>
              </mat-expansion-panel>
            </div>
          </div>
        } @else {
          <div class="empty-pack-message">No active pack selected. Create or select a pack to begin.</div>
        }
      </div>
    </div>
  }
</div>

@if (hoveredCard(); as card) {
  <div class="card-image-preview"
       [style.left.px]="mousePos().x + 20"
       [style.top.px]="mousePos().y + 20"
       [class.rotated]="card.layout === 'split'">
      @if (card.image_uris; as imageUris) {
        @if(imageUris.normal) {
          <img [src]="imageUris.normal" [alt]="card.name">
        }
      } @else if (card.card_faces && card.card_faces.length > 0) {
        @for (face of card.card_faces; track $index) {
          @if(face.image_uris; as faceImageUris){
            @if(faceImageUris.normal){
              <img [src]="faceImageUris.normal" [alt]="face.name">
            }
          }
        }
      }
  </div>
}

