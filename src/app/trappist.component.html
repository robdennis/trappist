<mat-toolbar color="primary" class="main-toolbar">
  <span>Trappist Deck Builder</span>
</mat-toolbar>

<div class="page-container">
  @if (isChecking()) {
    <div class="spinner-container">
      <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
    </div>
  } @else {
    @if (!dataExists()) {
      <app-database (dataLoaded)="checkIfDataExists()"></app-database>
    } @else {
      <div class="builder-section">
        <mat-card class="content-card control-panel">
          <mat-card-content class="button-row">
            <mat-form-field class="active-pack-selector">
              <mat-label>Visible Packs (up to 3)</mat-label>
              <mat-select [formControl]="packsControl" multiple>
                @for (pack of packs(); track pack.id) {
                  <mat-option [value]="pack.id">{{ pack.name }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
            <button mat-stroked-button color="primary" (click)="addPack()">
              <mat-icon>add_circle_outline</mat-icon> Add New Pack
            </button>
            <button mat-stroked-button (click)="exportPacks()">
              <mat-icon>download</mat-icon> Export Packs
            </button>
            <button mat-stroked-button (click)="triggerPacksImport()">
              <mat-icon>upload</mat-icon> Import Packs
            </button>
            <input type="file" class="hidden-file-input" #packsImporter accept=".json" (change)="importPacks($event)">

            <button mat-stroked-button (click)="isTagEditorVisible.set(!isTagEditorVisible())">
              <mat-icon>label</mat-icon> Tag Editor
            </button>

            <button mat-stroked-button color="warn" [matMenuTriggerFor]="clearMenu"
                    (mouseenter)="updateDbSize()"
                    [matTooltip]="dbSize() ? 'Local Data Size: ' + dbSize() : 'View options to clear local data'"
                    matTooltipPosition="above">
              <mat-icon>delete_forever</mat-icon> Clear Data
            </button>
            <mat-menu #clearMenu="matMenu">
              <button mat-menu-item (click)="clearCardData()">
                <mat-icon>style</mat-icon>
                <span>Clear Card Data</span>
              </button>
              <button mat-menu-item (click)="clearPackData()">
                <mat-icon>inventory_2</mat-icon>
                <span>Clear Pack Data</span>
              </button>
              <button mat-menu-item (click)="clearTagData()">
                <mat-icon>label_off</mat-icon>
                <span>Clear Tag Data</span>
              </button>
              <button mat-menu-item (click)="clearSetData()">
                <mat-icon>collections_bookmark</mat-icon>
                <span>Clear Set Data</span>
              </button>
              <mat-divider></mat-divider>
              <button mat-menu-item (click)="clearAllData()">
                <mat-icon color="warn">warning</mat-icon>
                <span>Clear All Data</span>
              </button>
            </mat-menu>
          </mat-card-content>
        </mat-card>

        @if(isTagEditorVisible()) {
          <app-tags (tagsUpdated)="loadTagsFromDb()"></app-tags>
        }

        <div class="packs-container">
            @if (visiblePacks().length > 0) {
                @for (pack of visiblePacks(); track pack.id) {
                    <app-packs
                        [pack]="pack"
                        [tags]="tags()"
                        [isDirty]="provisionalChanges().has(pack.id)"
                        (packUpdated)="handlePackUpdate($event)"
                        (savePack)="savePack($event)"
                        (discardChanges)="discardPackChanges($event)"
                        (removePack)="removePack($event)">
                    </app-packs>
                }
            } @else {
                <div class="empty-pack-message">No packs selected. Create or select a pack to begin.</div>
            }
        </div>
      </div>
    }
  }
</div>

