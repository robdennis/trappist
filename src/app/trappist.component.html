<div class="main-container">
  <mat-card class="content-wrapper">
    <mat-card-header class="header">
      <mat-card-title class="title">Trappist-1 Deck Builder</mat-card-title>
      <mat-card-subtitle class="subtitle">Local Card Database Management with IndexedDB</mat-card-subtitle>
    </mat-card-header>

    <mat-toolbar class="status-display" [ngClass]="{
      'status-success': status().includes('Successfully') || status().includes('found') || status().includes('Ready'),
      'status-error': status().includes('Error') || status().includes('Failed') || status().includes('delet'),
      'status-warning': !status().includes('Success') && !status().includes('Error')
    }">
      <span>Status: {{ status() }}</span>
    </mat-toolbar>

    <mat-card-content>
      <!-- DATA LOADER UI -->
      @if (!dataExists()) {
        @if (!isChecking()) {
          <div>
            <mat-button-toggle-group [(ngModel)]="inputMode" aria-label="Input Mode" class="input-mode-toggle">
              <mat-button-toggle value="url">From URL</mat-button-toggle>
              <mat-button-toggle value="file">From Local File</mat-button-toggle>
            </mat-button-toggle-group>

            @if (inputMode() === 'url') {
              <div class="input-section">
                <p>Provide the URL to download and store the collection.</p>
                <div class="url-input-group">
                  <mat-form-field appearance="outline" class="flex-grow">
                    <mat-label>JSON File URL</mat-label>
                    <input matInput #urlInput (input)="jsonUrl.set(urlInput.value)" [value]="jsonUrl()">
                  </mat-form-field>
                  <button mat-raised-button color="primary" (click)="downloadAndStoreData()" [disabled]="isLoading() || !jsonUrl()">
                    @if (isLoading()) {
                      <mat-spinner diameter="20" class="spinner"></mat-spinner>
                    }
                    {{ isLoading() ? 'Processing...' : 'Download & Store' }}
                  </button>
                </div>
              </div>
            }

            @if (inputMode() === 'file') {
              <div class="input-section file-input-section">
                <p>Select a JSON file from your local system to upload.</p>
                <input type="file" hidden #fileInput (change)="onFileSelected($event)">
                <button mat-stroked-button (click)="fileInput.click()">
                  <mat-icon>attach_file</mat-icon>
                  Choose File
                </button>
                @if (selectedFile()) {
                  <div class="selected-file-info">
                    Selected: <span>{{ selectedFile()?.name }} ({{ (selectedFile()?.size || 0) / 1024 | number:'1.1-2' }} KB)</span>
                  </div>
                }
                <button mat-raised-button color="primary" (click)="uploadAndStoreData()" [disabled]="isLoading() || !selectedFile()">
                   @if (isLoading()) {
                    <mat-spinner diameter="20" class="spinner"></mat-spinner>
                  }
                  {{ isLoading() ? 'Processing...' : 'Upload & Store' }}
                </button>

                @if (fileErrorDetails()) {
                  <div class="error-details">
                    <h4 class="error-title">
                      <mat-icon>error_outline</mat-icon>
                      <span>File Processing Error</span>
                    </h4>
                    <pre class="error-message">{{ fileErrorDetails() }}</pre>
                  </div>
                }
              </div>
            }
          </div>
        }
      }

      <!-- CARD SEARCH AND LIST UI -->
      @if (dataExists()) {
        <div>
          <div class="data-loaded-info">
              <div class="info-text">
                  <mat-icon color="primary">check_circle</mat-icon>
                  <span>Data is stored locally in IndexedDB!</span>
              </div>
            <p class="card-count">{{ cardCount() }} cards in database</p>
            <button mat-stroked-button color="warn" (click)="clearDatabase()" [disabled]="isLoading()">
              Clear Database
            </button>
          </div>

          <mat-form-field class="search-area" appearance="outline">
              <mat-label>Search for a Card</mat-label>
              <input type="text"
                     placeholder="Type a card name..."
                     matInput
                     [formControl]="searchControl"
                     [matAutocomplete]="auto">
              <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn" (optionSelected)="onSuggestionSelected($event)">
                @for(card of suggestions(); track card.id) {
                  <mat-option [value]="card">
                    <div class="suggestion-item">
                      <span>{{ card.name }}</span>
                      <span class="mana-cost" [innerHTML]="card.mana_cost | manaSymbol"></span>
                    </div>
                  </mat-option>
                }
              </mat-autocomplete>
          </mat-form-field>

          <h3 class="list-header">Card List ({{ addedCards().length }})</h3>
          <mat-list role="list" class="card-list-section">
            @for(card of addedCards(); track $index) {
              <mat-list-item role="listitem" class="card-item" (mouseenter)="showCardImage(card)" (mouseleave)="hideCardImage()">
                <div class="card-details">
                  <!-- Check for card faces -->
                  @if (card.card_faces && card.card_faces.length > 0) {
                    <div class="card-face-container">
                      @for(face of card.card_faces; track $index) {
                        <div class="card-face">
                          <h4 class="card-name">{{ face.name }} <span class="mana-cost" [innerHTML]="face.mana_cost | manaSymbol"></span></h4>
                          <p class="type-line">{{ face.type_line }}</p>
                          <p class="oracle-text" [innerHTML]="face.oracle_text | manaSymbol"></p>
                        </div>
                      }
                    </div>
                  } @else {
                    <!-- Original single-face display -->
                    <h4 class="card-name">{{ card.name }} <span class="mana-cost" [innerHTML]="card.mana_cost | manaSymbol"></span></h4>
                    <p class="type-line">{{ card.type_line }}</p>
                    <p class="oracle-text" [innerHTML]="card.oracle_text | manaSymbol"></p>
                  }
                </div>
                <button mat-icon-button color="warn" (click)="removeCardFromList($index)" aria-label="Remove card from list">
                  <mat-icon>remove_circle</mat-icon>
                </button>
              </mat-list-item>
            }
          </mat-list>
          @if(addedCards().length === 0) {
              <div class="empty-list-placeholder">
                <p>Your list is empty.</p>
                <p>Use the search bar above to find and add cards.</p>
              </div>
          }
        </div>
      }
    </mat-card-content>
  </mat-card>
</div>

<!-- Floating Card Image Preview -->
@if (hoveredCard(); as card) {
  <div class="image-preview"
    [style.left.px]="mousePos().x + 20"
    [style.top.px]="mousePos().y">
    <!-- Check for card faces -->
    @if (card.card_faces && card.card_faces.length > 0) {
      <div class="image-preview-multiface">
          @for(face of card.card_faces; track $index) {
              @if(face.image_uris?.normal; as imageUrl) {
                  <img [src]="imageUrl" alt="{{face.name}} Image" />
              }
          }
      </div>
    } @else {
      <!-- Original single-image display -->
      @if (card.image_uris?.normal; as imageUrl) {
          <img [src]="imageUrl" alt="Card Image" />
      }
    }
  </div>
}

