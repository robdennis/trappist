<mat-toolbar color="primary" class="main-toolbar">
  <span>Trappist Deck Builder</span>
</mat-toolbar>

<div class="page-container">
  @if (!dataExists()) {
    <mat-card class="content-card">
      <mat-card-header>
        <mat-card-title>Load Card Data</mat-card-title>
        <mat-card-subtitle>{{ status() }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        @if (isChecking() || isLoadingOptions()) {
          <div class="spinner-container">
            <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
          </div>
        } @else {
          <!-- Local File Upload -->
          <h3 class="data-source-header">Option 1: Upload from a local file</h3>
          <p class="data-source-description">
            If you have already downloaded a Scryfall bulk data JSON file, you can upload it here.
          </p>
          <div class="input-row">
              <button mat-stroked-button color="primary" (click)="fileInput.click()">
                <mat-icon>upload_file</mat-icon>
                Choose File
              </button>
              <input hidden (change)="onFileSelected($event)" #fileInput type="file" accept=".json">
              @if (selectedFile(); as file) {
                <span class="file-name">{{ file.name }}</span>
              }
              <button mat-raised-button color="primary" (click)="uploadAndStoreData()" [disabled]="!selectedFile() || isLoading()">
                  {{ isLoading() ? 'Uploading...' : 'Upload Data' }}
              </button>
          </div>

          <mat-divider class="section-divider"></mat-divider>

          <!-- Scryfall Bulk Data Options -->
          <h3 class="data-source-header">Option 2: Load directly from Scryfall</h3>
          <p class="data-source-description">
            Select a dataset to download from Scryfall and load it directly into the application's local database.
          </p>
          <mat-list>
            @for (option of bulkDataOptions(); track option.id) {
              <mat-list-item class="bulk-data-item">
                <mat-icon matListItemIcon>description</mat-icon>
                <div matListItemTitle class="item-title">{{ option.name }}</div>
                <div matListItemLine class="item-description">{{ option.description }}</div>
                <div matListItemLine class="item-meta">
                  <span><strong>Size:</strong> {{ formatBytes(option.size) }}</span>
                  <span><strong>Last Updated:</strong> {{ formatLastUpdated(option.updated_at) }}</span>
                </div>
                <div matListItemMeta class="item-actions">
                    <button mat-stroked-button (click)="downloadFileLocally(option)" matTooltip="Download this file to your computer for later use.">
                      <mat-icon>download</mat-icon> Download to Computer
                    </button>
                    <button mat-raised-button color="primary" (click)="downloadAndStoreData(option)" [disabled]="isLoading()">
                      {{ isLoading() ? 'Loading...' : 'Load into App' }}
                    </button>
                </div>
              </mat-list-item>
            }
          </mat-list>
        }
        @if (isLoading()) {
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        }
        @if (fileErrorDetails(); as error) {
            <div class="error-details">{{ error }}</div>
        }
      </mat-card-content>
    </mat-card>
  } @else {
    <div class="builder-section">
      <mat-card class="content-card control-panel">
        <mat-card-content class="button-row">
          <mat-form-field class="active-pack-selector">
            <mat-label>Active Pack</mat-label>
            <mat-select [value]="activePackId()" (valueChange)="setActivePack($event)">
              @for (pack of packs(); track pack.id) {
                <mat-option [value]="pack.id">{{ pack.name }}</mat-option>
              }
            </mat-select>
          </mat-form-field>
          <button mat-stroked-button color="primary" (click)="addPack()">
            <mat-icon>add_circle_outline</mat-icon> Add New Pack
          </button>
          <button mat-stroked-button (click)="exportPacks()">
            <mat-icon>download</mat-icon> Export Packs
          </button>
          <button mat-stroked-button (click)="triggerPacksImport()">
            <mat-icon>upload</mat-icon> Import Packs
          </button>
          <input type="file" class="hidden-file-input" #packsImporter accept=".json" (change)="importPacks($event)">
           @if (activePack(); as pack) {
             <button mat-stroked-button color="warn" (click)="removePack(pack.id)">
                <mat-icon>delete</mat-icon> Delete Active Pack
              </button>
           }
          <button mat-stroked-button (click)="isTagEditorVisible.set(!isTagEditorVisible())" [class.active-toggle]="isTagEditorVisible()">
            <mat-icon>label</mat-icon> Tag Editor
          </button>
          <button mat-stroked-button color="warn" [matMenuTriggerFor]="clearMenu"
                  (mouseenter)="updateDbSize()"
                  [matTooltip]="dbSize() ? 'Local Data Size: ' + dbSize() : 'View options to clear local data'"
                  matTooltipPosition="above">
            <mat-icon>delete_forever</mat-icon> Clear Data
          </button>
          <mat-menu #clearMenu="matMenu">
            <button mat-menu-item (click)="clearCardData()">
              <mat-icon>style</mat-icon>
              <span>Clear Card Data</span>
            </button>
            <button mat-menu-item (click)="clearPackData()">
              <mat-icon>inventory_2</mat-icon>
              <span>Clear Pack Data</span>
            </button>
            <button mat-menu-item (click)="clearTagData()">
              <mat-icon>label_off</mat-icon>
              <span>Clear Tag Data</span>
            </button>
            <mat-divider></mat-divider>
            <button mat-menu-item (click)="clearAllData()">
              <mat-icon color="warn">warning</mat-icon>
              <span>Clear All Data</span>
            </button>
          </mat-menu>
        </mat-card-content>
      </mat-card>

      <!-- TAG EDITOR -->
      @if(isTagEditorVisible()) {
        <mat-card class="content-card tag-editor">
          <mat-card-header>
              <mat-card-title>Tag Editor</mat-card-title>
          </mat-card-header>
          <mat-card-content class="tag-editor-content">
            <div class="tag-list-container">
              <div class="tag-list-actions">
                  <button mat-stroked-button (click)="addNewTag()"><mat-icon>add</mat-icon> New Tag</button>
                  <button mat-stroked-button (click)="exportTags()"><mat-icon>download</mat-icon> Export</button>
                  <button mat-stroked-button (click)="triggerTagsImport()"><mat-icon>upload</mat-icon> Import</button>
                  <input type="file" class="hidden-file-input" #tagsImporter accept=".json" (change)="importTags($event)">
              </div>
              <mat-list>
                @for(tag of tags(); track tag.id) {
                  <mat-list-item (click)="selectTagForEditing(tag)" [class.selected]="selectedTag()?.id === tag.id">
                      <div matListItemIcon class="tag-icon-display" [innerHTML]="getIconHtml(tag.icon)"></div>
                      <div matListItemTitle>{{ tag.name }}</div>
                      <div matListItemLine>{{tag.type}}</div>
                  </mat-list-item>
                }
              </mat-list>
            </div>
            <div class="tag-details-container">
              @if (selectedTag(); as tag) {
                <div class="tag-form">
                    <mat-form-field><mat-label>Name</mat-label><input matInput [(ngModel)]="tag.name"></mat-form-field>

                    <div class="icon-picker-field">
                      <span class="icon-label">Icon:</span>
                      <button mat-stroked-button (click)="openIconPicker()">
                        <span class="selected-icon-display" [innerHTML]="getIconHtml(tag.icon)"></span>
                         Choose Icon
                      </button>
                    </div>

                    <mat-form-field><mat-label>Category</mat-label><input matInput [(ngModel)]="tag.category"></mat-form-field>
                    <mat-form-field><mat-label>Description</mat-label><textarea matInput [(ngModel)]="tag.description"></textarea></mat-form-field>
                    <mat-form-field><mat-label>Tag Type</mat-label>
                      <mat-select [(ngModel)]="tag.type">
                        <mat-option value="local">Local</mat-option>
                        <mat-option value="remote">Remote (Scryfall)</mat-option>
                      </mat-select>
                    </mat-form-field>

                    @if(tag.type === 'local') {
                      <div class="local-query-builder">
                        <h4>Local Query</h4>
                        <!-- Simple JSON editor for now -->
                        <mat-form-field>
                          <mat-label>Query JSON</mat-label>
                          <textarea matInput cdkTextareaAutosize #autosize="cdkTextareaAutosize" [ngModel]="tag.query | json" (ngModelChange)="updateTagQuery($event)" placeholder='{ "field": "cmc", "op": "lte", "value": 2 }'></textarea>
                        </mat-form-field>
                      </div>
                    }

                    @if(tag.type === 'remote') {
                      <div class="remote-query-builder">
                        <h4>Remote Scryfall Query</h4>
                        <mat-form-field><mat-label>Scryfall Query</mat-label><input matInput [(ngModel)]="tag.scryfall_query"></mat-form-field>
                        <button mat-stroked-button (click)="cacheRemoteTag(tag.id)" [disabled]="isLoadingTags()">
                           <mat-icon>cloud_sync</mat-icon> Cache Card Names
                        </button>
                        <span>Cached Names: {{ tag.cached_card_names?.length || 0 }}</span>
                      </div>
                    }

                    <div class="tag-form-actions">
                      <button mat-stroked-button (click)="selectTagForEditing(null)">Cancel</button>
                      <button mat-raised-button color="primary" (click)="saveSelectedTag()">Save Tag</button>
                      <button mat-stroked-button color="warn" (click)="deleteTag(tag.id)">Delete</button>
                    </div>
                </div>
              } @else {
                <div class="no-tag-selected">
                  <p>Select a tag to edit, or create a new one.</p>
                  <button mat-flat-button color="primary" (click)="applyAllTags()" [disabled]="isLoading() || !!taggingProgress()">
                    <mat-icon>sync</mat-icon> Clear and Re-apply All Tags
                  </button>

                  @if(taggingProgress(); as progress) {
                    <div class="tag-progress-container">
                      <h4>{{ progress.status }}</h4>
                      @if(progress.status !== 'Complete!') {
                        <mat-progress-bar mode="determinate" [value]="(progress.processedTags / progress.totalTags) * 100"></mat-progress-bar>
                      }
                      <div class="progress-details">
                        @if(progress.currentTag) {
                          <span>Tag {{ progress.processedTags }} / {{ progress.totalTags }}: <strong>{{ progress.currentTag }}</strong></span>
                          <span>Matches: <strong>{{ progress.currentTagMatches }}</strong></span>
                        }
                        <span>Elapsed: <strong>{{ progress.elapsedTime }}</strong></span>
                        @if (progress.finalDbSize && progress.initialDbSize) {
                          <span>DB Size Change: <strong>+{{ formatBytes(progress.finalDbSize - progress.initialDbSize) }}</strong></span>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            </div>
          </mat-card-content>
        </mat-card>
      }

      <div class="packs-container">
        @if (activePack(); as pack) {
          <div class="pack-grid-layout">
            <!-- Left Column: Pack Info -->
            <div class="pack-info-left">
               <mat-form-field class="pack-name-input">
                <mat-label>Pack Name</mat-label>
                <input matInput [ngModel]="pack.name" (ngModelChange)="onPackMetaChange(pack.id, 'name', $event)">
              </mat-form-field>

              <div class="signpost-image-container">
                @if (getSignpostCardArtCrop(pack); as artCropUrl) {
                  <img [src]="artCropUrl" alt="Signpost card art">
                } @else {
                  <div class="no-image-placeholder">
                    <mat-icon>photo_library</mat-icon>
                    <span>No Signpost Image</span>
                  </div>
                }
              </div>

              <div class="pack-details-bottom">
                  <mat-form-field>
                    <mat-label>Archetype</mat-label>
                    <input matInput [ngModel]="getCurrentRevision(pack).archetype" (ngModelChange)="onPackMetaChange(pack.id, 'archetype', $event)">
                  </mat-form-field>
                  <mat-form-field>
                    <mat-label>Themes</mat-label>
                    <input matInput [ngModel]="getCurrentRevision(pack).themes" (ngModelChange)="onPackMetaChange(pack.id, 'themes', $event)">
                  </mat-form-field>
              </div>
            </div>

            <!-- Right Column: Card Slots -->
            <div class="card-slots-right">
                <div class="pack-header">
                    <h3>
                        {{ pack.name }}
                        <span class="pack-count">({{ getFilledSlotsCount(pack) }} / {{ getCurrentRevision(pack).size }})</span>
                        <mat-icon *ngIf="provisionalChanges().has(pack.id)" class="provisional-indicator" matTooltip="Unsaved changes">edit</mat-icon>
                    </h3>
                    @if(provisionalChanges().has(pack.id)) {
                        <div class="provisional-actions">
                            <button mat-flat-button color="primary" (click)="savePackChanges(pack.id)">
                                <mat-icon>save</mat-icon> Save
                            </button>
                            <button mat-stroked-button (click)="discardPackChanges(pack.id)">
                                <mat-icon>undo</mat-icon> Discard
                            </button>
                        </div>
                    }
                </div>

                <div class="card-slots-grid-container">
                    <div class="slot-labels-column">
                        @for (slotIndex of getSlotsArray(pack); track slotIndex) {
                            <div class="slot-label">
                                <input class="slot-input"
                                       [ngModel]="getCurrentRevision(pack).slots?.[slotIndex]"
                                       (ngModelChange)="onSlotLabelChange(pack.id, slotIndex, $event)">
                            </div>
                        }
                    </div>
                    <div class="card-drop-list" cdkDropList [cdkDropListData]="pack.cards" (cdkDropListDropped)="onCardDrop($event)">
                        @for (slotIndex of getSlotsArray(pack); track slotIndex) {
                            <div class="card-row" cdkDrag [cdkDragData]="pack.cards[slotIndex]" [cdkDragDisabled]="!pack.cards[slotIndex]">
                                <div class="slot-drag-handle" cdkDragHandle>
                                    @if (pack.cards[slotIndex]) {
                                        <mat-icon>drag_indicator</mat-icon>
                                    }
                                </div>
                                @if(pack.cards[slotIndex]; as card) {
                                    <!-- Filled Slot -->
                                    <div class="tags-cell">
                                      @for(tagIcon of card.tags; track tagIcon) {
                                          <span class="card-tag" [matTooltip]="getTagTooltip(tagIcon)" [innerHTML]="getIconHtml(tagIcon)"></span>
                                      }
                                    </div>
                                    <div class="mana-cost-cell" (mouseenter)="showCardImage(card)" (mouseleave)="hideCardImage()">
                                        <span [innerHTML]="getDisplayManaCost(card) | manaSymbol"></span>
                                    </div>
                                    <div class="card-cell"
                                        (mouseenter)="showCardImage(card)"
                                        (mouseleave)="hideCardImage()"
                                        [class.is-signpost-card]="card.id === getCurrentRevision(pack).signpostCardId">
                                        <span class="card-name">{{ card.name }}</span>
                                    </div>
                                    <div class="actions-cell">
                                        <button mat-icon-button matTooltip="Set as signpost card" (click)="setSignpostCard(pack.id, card.id)">
                                            <mat-icon>push_pin</mat-icon>
                                        </button>
                                        <button mat-icon-button color="warn" matTooltip="Remove card" (click)="removeCardFromSlot(pack.id, slotIndex)">
                                            <mat-icon>remove_circle_outline</mat-icon>
                                        </button>
                                    </div>
                                } @else {
                                    <!-- Empty Slot -->
                                    <div class="tags-cell empty"></div>
                                    <div class="mana-cost-cell empty"></div>
                                    <div class="card-cell empty">
                                        <mat-form-field class="slot-search-field">
                                            <input type="text"
                                                matInput
                                                [formControl]="slotControls[slotIndex]"
                                                [matAutocomplete]="auto"
                                                (focus)="setActiveSlot(slotIndex)">
                                            <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn" (optionSelected)="addCardToSlot($event.option.value, slotIndex)">
                                            @for (suggestion of suggestions(); track suggestion.id) {
                                                <mat-option [value]="suggestion" (mouseenter)="showCardImage(suggestion)" (mouseleave)="hideCardImage()">
                                                  <div class="suggestion-item">
                                                    <span class="suggestion-name">{{ suggestion.name }}</span>
                                                    <span class="suggestion-meta" [class.has-mana-cost]="getDisplayManaCost(suggestion)" [class.no-mana-cost]="!getDisplayManaCost(suggestion)">
                                                      @if (getDisplayManaCost(suggestion); as manaCost) {
                                                        <span class="mana-cost" [innerHTML]="manaCost | manaSymbol"></span>
                                                      } @else {
                                                        <span class="suggestion-color-identity" [innerHTML]="getColorIdentityManaString(suggestion) | manaSymbol"></span>
                                                        <span class="suggestion-type-line">{{ suggestion.type_line }}</span>
                                                      }
                                                    </span>
                                                  </div>
                                                </mat-option>
                                            }
                                            </mat-autocomplete>
                                        </mat-form-field>
                                    </div>
                                    <div class="actions-cell empty"></div>
                                }
                            </div>
                        }
                    </div>
                </div>

                <mat-expansion-panel class="history-panel">
                  <mat-expansion-panel-header>
                      <mat-panel-title>
                          <mat-icon>history</mat-icon>
                          Revision History ({{pack.revisions.length}})
                      </mat-panel-title>
                  </mat-expansion-panel-header>
                  <mat-list>
                      @for(revision of pack.revisions.slice().reverse(); track revision.timestamp){
                          <mat-list-item [class.current-revision]="revision.timestamp === getCurrentRevision(pack).timestamp">
                              <div class="revision-item">
                                  <span>{{formatTimestamp(revision.timestamp)}} - {{ revision.reason || (revision.cardIds.length + ' cards') }}</span>
                                  <button mat-stroked-button (click)="revertToRevision(pack.id, revision)" [disabled]="revision.timestamp === getCurrentRevision(pack).timestamp">
                                      Revert
                                  </button>
                              </div>
                          </mat-list-item>
                      }
                  </mat-list>
              </mat-expansion-panel>
            </div>
          </div>
        } @else {
          <div class="empty-pack-message">No active pack selected. Create or select a pack to begin.</div>
        }
      </div>
    </div>
  }
</div>

@if (hoveredCard(); as card) {
  <div class="card-image-preview"
       [style.left.px]="mousePos().x + 20"
       [style.top.px]="mousePos().y + 20"
       [class.rotated]="card.layout === 'split'">
      @if (card.image_uris; as imageUris) {
        @if(imageUris.normal) {
          <img [src]="imageUris.normal" [alt]="card.name">
        }
      } @else if (card.card_faces && card.card_faces.length > 0) {
        @for (face of card.card_faces; track $index) {
          @if(face.image_uris; as faceImageUris){
            @if(faceImageUris.normal){
              <img [src]="faceImageUris.normal" [alt]="face.name">
            }
          }
        }
      }
  </div>
}

@if (isIconPickerVisible()) {
  <div class="icon-picker-overlay" (click)="closeIconPicker()">
    <div class="icon-picker-dialog" (click)="$event.stopPropagation()">
      <div class="icon-picker-header">
        <h3>Select an Icon</h3>
        <mat-form-field appearance="outline" class="icon-search-field">
          <mat-label>Search Icons</mat-label>
          <input matInput [ngModel]="iconSearchTerm()" (ngModelChange)="iconSearchTerm.set($event)">
          <mat-icon matSuffix>search</mat-icon>
        </mat-form-field>
        <button mat-icon-button (click)="closeIconPicker()">
          <mat-icon>close</mat-icon>
        </button>
      </div>
      <div class="icon-picker-content">
        @for (category of objectKeys(filteredIcons()); track category) {
          <div class="icon-category">
            <h4>{{ category }}</h4>
            <div class="icon-grid">
              @for (icon of filteredIcons()[category].icons; track icon) {
                <button mat-icon-button (click)="selectIcon(icon)" [matTooltip]="icon">
                  <span [innerHTML]="getIconHtml(icon)"></span>
                </button>
              }
            </div>
          </div>
        }
      </div>
    </div>
  </div>
}

