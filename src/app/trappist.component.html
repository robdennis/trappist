<mat-toolbar color="primary" class="main-toolbar">
  <span>Trappist Deck Builder</span>
</mat-toolbar>

<div class="page-container">
  @if (!dataExists()) {
    <mat-card class="content-card">
      <mat-card-header>
        <mat-card-title>Load Card Data</mat-card-title>
        <mat-card-subtitle>{{ status() }}</mat-card-subtitle>
      </mat-card-header>
      <mat-card-content>
        @if (isChecking()) {
          <div class="spinner-container">
            <mat-progress-spinner mode="indeterminate"></mat-progress-spinner>
          </div>
        } @else {
          <div class="data-controls">
            <mat-button-toggle-group [(ngModel)]="inputMode" aria-label="Input Mode">
              <mat-button-toggle value="url">From URL</mat-button-toggle>
              <mat-button-toggle value="file">From File</mat-button-toggle>
            </mat-button-toggle-group>

            @if (inputMode() === 'url') {
              <div class="input-row">
                <mat-form-field class="full-width">
                  <mat-label>JSON Data URL</mat-label>
                  <input matInput [ngModel]="jsonUrl()" (ngModelChange)="jsonUrl.set($event)">
                </mat-form-field>
                <button mat-raised-button color="primary" (click)="downloadAndStoreData()" [disabled]="isLoading()">
                  {{ isLoading() ? 'Downloading...' : 'Download Data' }}
                </button>
              </div>
            } @else {
              <div class="input-row">
                 <button mat-stroked-button color="primary" (click)="fileInput.click()">
                    <mat-icon>upload_file</mat-icon>
                    Choose File
                  </button>
                  <input hidden (change)="onFileSelected($event)" #fileInput type="file" accept=".json">
                  @if (selectedFile(); as file) {
                    <span class="file-name">{{ file.name }}</span>
                  }
                  <button mat-raised-button color="primary" (click)="uploadAndStoreData()" [disabled]="!selectedFile() || isLoading()">
                     {{ isLoading() ? 'Uploading...' : 'Upload Data' }}
                  </button>
              </div>
            }
          </div>
        }
        @if (isLoading()) {
          <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        }
        @if (fileErrorDetails(); as error) {
            <div class="error-details">{{ error }}</div>
        }
      </mat-card-content>
    </mat-card>
  } @else {
    <div class="builder-section">
      <mat-card class="content-card">
        <mat-card-header class="search-header">
           <mat-form-field class="full-width">
            <mat-label>Search for a card to add</mat-label>
            <input type="text"
                   matInput
                   [formControl]="searchControl"
                   [matAutocomplete]="auto">
            <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFn" (optionSelected)="onSuggestionSelected($event)">
              @for (suggestion of suggestions(); track suggestion.id) {
                <mat-option [value]="suggestion">
                  <div class="suggestion-item">
                      <span>{{ suggestion.name }}</span>
                      <span class="mana-cost" [innerHTML]="suggestion.mana_cost | manaSymbol"></span>
                  </div>
                </mat-option>
              }
            </mat-autocomplete>
          </mat-form-field>
           <mat-form-field class="active-pack-selector">
                <mat-label>Active Pack</mat-label>
                <mat-select [value]="activePackId()" (valueChange)="setActivePack($event)">
                  @for (pack of packs(); track pack.id) {
                    <mat-option [value]="pack.id">{{ pack.name }}</mat-option>
                  }
                </mat-select>
            </mat-form-field>
        </mat-card-header>
         <mat-card-content class="button-row">
            <button mat-stroked-button color="primary" (click)="addPack()">
              <mat-icon>add_circle_outline</mat-icon> Add New Pack
            </button>
            <button mat-stroked-button (click)="exportPacks()">
              <mat-icon>download</mat-icon> Export Packs
            </button>
            <button mat-stroked-button (click)="triggerPacksImport()">
              <mat-icon>upload</mat-icon> Import Packs
            </button>
             <input type="file" class="hidden-file-input" #packsImporter accept=".json" (change)="importPacks($event)">
            <button mat-stroked-button color="warn" (click)="clearDatabase()">
              <mat-icon>delete_forever</mat-icon> Clear All Data
            </button>
          </mat-card-content>
      </mat-card>

      <div class="packs-container">
        @for (pack of packs(); track pack.id) {
          <mat-card class="pack-card" [class.active-pack]="pack.id === activePackId()">
            <mat-card-header (click)="setActivePack(pack.id)">
               <img mat-card-avatar [src]="getFaceCardArtCrop(pack)" *ngIf="getFaceCardArtCrop(pack)" alt="Face card art">
              <mat-card-title>
                 <mat-form-field class="pack-name-input">
                    <input matInput [ngModel]="pack.name" (ngModelChange)="pack.name = $event">
                  </mat-form-field>
              </mat-card-title>
              <mat-card-subtitle class="pack-meta">
                <span class="pack-count">{{ pack.cards.length }} / {{ pack.size }}</span>
                 <button mat-icon-button color="warn" (click)="$event.stopPropagation(); removePack(pack.id)">
                    <mat-icon>delete</mat-icon>
                  </button>
              </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              @if (pack.cards.length > 0) {
                <mat-list>
                  @for (card of pack.cards; track $index) {
                    <mat-list-item
                        (mouseenter)="showCardImage(card)"
                        (mouseleave)="hideCardImage()"
                        [class.is-face-card]="card.id === pack.faceCardId">
                      <div class="card-list-item-content">
                        <div class="card-info">
                          <div class="card-name-mana">
                            <span class="card-name">{{ card.name }}</span>
                            <span class="mana-cost" [innerHTML]="card.mana_cost | manaSymbol"></span>
                          </div>
                          <div class="type-line">{{ card.type_line }}</div>
                          @if(card.card_faces && card.card_faces.length > 0) {
                            @for(face of card.card_faces; track $index){
                                <div class="card-face-details">
                                    <div class="card-name-mana">
                                        <span class="card-name">{{ face.name }}</span>
                                        <span class="mana-cost" [innerHTML]="face.mana_cost | manaSymbol"></span>
                                    </div>
                                    <div class="type-line">{{ face.type_line }}</div>
                                    <p class="oracle-text" [innerHTML]="face.oracle_text | manaSymbol"></p>
                                </div>
                            }
                          } @else {
                            <p class="oracle-text" [innerHTML]="card.oracle_text | manaSymbol"></p>
                          }
                        </div>
                        <div class="card-actions">
                          <button mat-icon-button matTooltip="Set as face card" (click)="setFaceCard(pack.id, card.id)">
                            <mat-icon>face</mat-icon>
                          </button>
                          <button mat-icon-button color="warn" matTooltip="Remove card" (click)="removeCardFromPack(pack.id, $index)">
                            <mat-icon>remove_circle_outline</mat-icon>
                          </button>
                        </div>
                      </div>
                    </mat-list-item>
                  }
                </mat-list>
              } @else {
                <div class="empty-pack-message">This pack is empty. Add cards using the search bar above.</div>
              }
            </mat-card-content>
          </mat-card>
        }
        <div class="add-pack-container">
            <button mat-fab extended color="primary" (click)="addPack()">
                <mat-icon>add</mat-icon>
                Add New Pack
            </button>
        </div>
      </div>
    </div>
  }
</div>


  @if (hoveredCard(); as card) {
    <div class="card-image-preview" [style.left.px]="mousePos().x + 20" [style.top.px]="mousePos().y + 20">
        @if (card.card_faces && card.card_faces.length > 0) {
            @for (face of card.card_faces; track $index) {
                @if(face.image_uris?.normal){
                  <img [src]="face.image_uris?.normal" [alt]="face.name">
                }
            }
        } @else {
           @if(card.image_uris?.normal){
              <img [src]="card.image_uris?.normal" [alt]="card.name">
          }
        }
    </div>
  }

